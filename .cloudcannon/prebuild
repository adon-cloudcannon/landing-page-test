#!/bin/bash

declare -A SYNC_PATHS_DICT

function check_and_add {
    local path=$1
    local old_time=$2

    
    local new_time=$(date -r "$path" +%s)

 
    if (( old_time != new_time )); then
        echo "ðŸ“„ File $path has been modified"
     
        if [[ -z "${SYNC_PATHS_DICT[$path]}" ]]; then
            SYNC_PATHS_DICT[$path]=1

            
            if [[ ! -z "$SYNC_PATHS" ]]; then
                SYNC_PATHS+=","
            fi

            
            SYNC_PATHS+="${path}"
            echo "âž• Adding $path to SYNC_PATHS"
        fi
    fi
}

npm i
node generate-build-schedule.js

outfile="src/_data/filter-tags.yml"


old_time_outfile=$(date -r "$outfile" +%s 2>/dev/null || echo 0)

tempfile=$(mktemp)

echo "ðŸ·ï¸ Generating tags at $outfile"
if [[ -f "$outfile" ]]; then
    echo "ðŸ·ï¸ Copying $outfile to $tempfile"
    cp "$outfile" "$tempfile"
fi

while IFS= read -r line; do
    if [[ "$line" =~ :$ ]]; then
        key=${line%:}
        file="src/_data/$key.yml"
        
        echo -n > "$file"
        continue
    fi

    line="${line#"${line%%[![:space:]]*}"}"
    echo "$line" >> "$file"

done < "$tempfile"

rm -f "$tempfile"

rm -f "$outfile"


declare -A old_time_files

for file in src/_data/filter-*.yml; do
    echo "ðŸ·ï¸ Reading $file..."
    base=$(basename -- "$file")
    key="${base%.*}"

    echo "$key:" >> "$outfile"

   
    old_time_files["$file"]=$(date -r "$file" +%s 2>/dev/null || echo 0)

    while IFS= read -r line; do
        if [[ ! -z "$line" ]]; then
            line="${line#"${line%%[![:space:]]*}"}"
            echo "  $line" >> "$outfile"
        fi
    done < "$file"
done


check_and_add "$outfile" "$old_time_outfile"

for file in src/_data/filter-*.yml; do
    check_and_add "$file" "${old_time_files["$file"]}"
done

cat $outfile

echo "ðŸ·ï¸ Done generating tags at $outfile, listing files:"
ls -l src/_data


if [[ -z "$SYNC_PATHS" ]]; then
    echo "âš ï¸ No files have been changed"
else
    echo "âœ… The following files have been changed and added to SYNC_PATHS: ${SYNC_PATHS}"
    export SYNC_PATHS
fi
