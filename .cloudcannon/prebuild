#!/bin/bash

npm i
node generate-build-schedule.js

outfile="src/_data/filter-tags.yml"

tempfile=$(mktemp)

echo "ğŸ·ï¸ Generating tags at $outfile"
if [[ -f "$outfile" ]]; then
    echo "ğŸ·ï¸ Copying $outfile to $tempfile"
    cp "$outfile" "$tempfile"
fi

cat "$tempfile" | while read -r line; do
    if [[ "$line" =~ :$ ]]; then
        key=${line%:}
        file="src/_data/$key.yml"
        
        truncate -s 0 "$file"
        continue
    fi

    line="${line#"${line%%[![:space:]]*}"}"
    echo "$line" >> "$file"

done

rm -f "$tempfile"

rm -f "$outfile"

SYNC_PATHS=""

for file in src/_data/filter-*.yml; do
    echo "ğŸ·ï¸ Reading $file..."
    base=$(basename -- "$file")
    key="${base%.*}"

    echo "$key:" >> "$outfile"

    cat "$file" | while read -r line; do
        if [[ ! -z "$line" ]]; then
            line="${line#"${line%%[![:space:]]*}"}"
            echo "  $line" >> "$outfile"
        fi
    done

    SYNC_PATHS="${SYNC_PATHS}${file},"
done

SYNC_PATHS=${SYNC_PATHS%,}

echo "ğŸ·ï¸ SYNC_PATHS=$SYNC_PATHS"

cat $outfile

echo "ğŸ·ï¸ Done generating tags at $outfile, listing files:"
ls -l src/_data
